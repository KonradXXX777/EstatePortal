@model EstatePortal.Models.Chat

<h2>Czat z @Model.Receiver.FirstName @Model.Receiver.LastName</h2>
<div id="messages"></div>

<input type="text" id="messageInput" placeholder="Napisz wiadomość..." />
<button id="sendButton">Wyślij</button>

@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/6.0.9/signalr.min.js"></script>
    <script>
        const chatId = "@Model.Id";
        const senderId = "@User.FindFirst("UserId")?.Value";
        const connection = new signalR.HubConnectionBuilder().withUrl("/chathub").build();

        connection.on("ReceiveMessage", (senderId, message) => {
            const messagesDiv = document.getElementById("messages");
            const messageDiv = document.createElement("div");
            messageDiv.innerHTML = `<strong>${senderId}:</strong> ${message}`;
            messagesDiv.appendChild(messageDiv);
        });

        connection.start().then(() => {
            console.log("SignalR connected");
            connection.invoke("JoinChat", chatId);
        });

        document.getElementById("sendButton").addEventListener("click", async () => {
            const message = document.getElementById("messageInput").value;
            if (message.trim() === "") {
                alert("Nie można wysłać pustej wiadomości.");
                return;
            }

            try {
                await connection.invoke("SendMessage", chatId, senderId, message);
                document.getElementById("messageInput").value = ""; // Wyczyść pole
            } catch (err) {
                console.error(err);
                alert("Błąd podczas wysyłania wiadomości.");
            }
        });
    </script>
}
